<div class="row featurette hero-top">
  <div class="col-md-2 col-sm-2">
    <div data-spy="affix" id="sponsor-list" class="hidden-xs" data-id-list="" data-offset-top="50" data-offset-bottom="740">
      <% if live_campaigns? -%>
        <div class="panel panel-primary">
          <div class="panel-heading">
            <h2 class="panel-title">Children I Want to Sponsor</h2>
          </div>

          <ul class="list-group" id="sponsor-list">
            <li id="empty-list-message" class="list-group-item disabled">No wish lists selected</li>
          </ul>
        </div>
        <%= link_to 'Complete Donation', donate_url(:id_list => ""), :class => 'btn btn-warning disabled btn-lg focus', :id => 'checkout-btn' %>
      <% end -%>
    </div>
  </div>
  <div class="col-md-6 col-md-offset-1 col-sm-6 col-sm-offset-1">
    <h2 class="featurette-heading">Home Libraries<%= " for #{@organization.name}" unless @organization.nil? %></h2>
    <p class="lead"><%= live_campaigns? ? @content['sponsor_lead'] : @content['sponsor_lead_no_campaign'] %></p>
    <% if @organization.nil? -%>
      <p class="donation">
        <%= link_to 'Program Donation', donate_url(:id_list => ""), :class => 'btn btn-primary', :id => 'program-checkout' %>
      </p>
    <% else -%>
      <p class="donation">
        <%= link_to "Program Donation to #{@organization.name}", donate_url(:campaign_id => @organization.current_campaign), :class => 'btn btn-primary', :id => 'program-checkout' if live_campaigns? %>
        <%= link_to "Program Donation to #{@organization.name}", donate_url(:organization_id => @organization.id), :class => 'btn btn-primary', :id => 'program-checkout' unless live_campaigns? %>
      </p>
    <% end -%>
    <% if live_campaigns? %>
      <%= form_tag("/wishlists?slug=#{params[:slug]}", method: :get, remote: true) do %>
        <div class="input-group">
          <input class="form-control" name="term" id="term" placeholder="Find a child, teacher, or school" />
          <span class="input-group-btn">
            <button class="btn btn-primary" type="submit">Search</button>
          </span>
      </div>
      <% end -%>
    <% end -%>
  </div>
</div>
<% if live_campaigns? -%>
  <div class="row">
    <div class="col-md-8 col-md-offset-3 col-sm-offset-3 col-sm-8">
      <div id="search_results">
        <%= render partial: 'search_results', locals: {wishlists: @wishlists} %>
      </div>
      <p>
        <%= link_to 'Load More Wish Lists', "/wishlists?slug=#{params[:slug]}&append=true", :remote => true, :class => 'btn btn-info', :id => 'load-more' %>
      </p>
    </div>
  </div>
<% end -%>

<%= render :partial => 'common/sponsor' %>
<%= content_for :foot do %>
<script>
var preselected = "<%= session[:wishlist_cart] %>";

if(preselected.length > 0){
  $(document).ready(function() {
    $.each(preselected.split(','), function(idx, id){
      addIdToCart(id);
    });
  });
}

$('body').on('click', '.donation', function(){
  var modalDonation = '<h5 style="color:red">Please note: if you are sponsoring a child and additionally want to make a program donation, please use the "Complete Donation" button on the left of main page.</h5>\
  <div><button type="button" class="btn btn-default" data-dismiss="modal">Sponsor a Child</button></div>\
  <div class="input-group"><span>Please input your amount:</span>\
  <input type="number" step="1.00" id="addl_donation_slug" class="form-control" placeholder="Enter dollar amount" /></div>\
  <div><% if @organization.nil? -%>\
  <%= link_to "Complete Donation", donate_url(), :class => "btn btn-warning btn-lg focus", :id => "checkout-btn-3" %></div>\
  <% else -%>\
  <%= link_to "Complete Donation to #{@organization.name}", donate_url(:campaign_id => @organization.current_campaign), :id => "checkout-btn-3", :class => 'btn btn-warning btn-lg focus' if live_campaigns? %>\
  <%= link_to "Complete Donation to #{@organization.name}", donate_url(:organization_id => @organization.id), :id => "checkout-btn-3", :class => 'btn btn-warning btn-lg focus' unless live_campaigns? %>\
  <% end -%>'

  $("#globalModalShopping .modal-body").html(modalDonation);
  $('#globalModalShopping').modal();

  return false;
});

$('body').on("click", '.search-entry a', function() {
  if (!$('#sponsor-list').is(':visible')) return true;
  var entry = $(this).closest('.search-entry');
  addToCart(entry);

  var modalShopping = '<div><span>Thank you for sponsoring a child!</span>\
  <button type="button" class="btn btn-default" data-dismiss="modal">Sponsor Another Child</button></div>\
  <div class="input-group"><span>You can also add a general donation to your cart as well.</span>\
  <input type="number" step="1.00" id="addl_donation" class="form-control" placeholder="Enter dollar amount" /></div>\
  <div><%= link_to "Complete Donation", donate_url(), :class => "btn btn-warning btn-lg focus", :id => "checkout-btn-2" %></div>'

  $("#globalModalShopping .modal-body").html(modalShopping);
  $('#globalModalShopping').modal();

  return false;
});

$('body').on("click", '.list-group-item button', function() {
  var entry = $(this).closest('li');
  var id = entry.data('wishlist-id');
  var idList = updateIdList(id, null, true);

  entry.remove();

  return false;
});

function updateIdList(id, text, isRemove) {
  var list = $('#sponsor-list');
  var idList = list.data('id-list');

  if (idList.length == 0) {
    idList = [];
  }

  if (!isRemove && idList.indexOf(id) >= 0) {
    return idList;
  }

  if (isRemove) {
    idList.splice(idList.indexOf(id), 1);
  } else {
    idList[idList.length] = id;
  }


  updateCheckoutUrl(idList);
  list.data('id-list', idList);

  if (!isRemove) {
    var li = $('<li class="list-group-item">' + text + ': $30.00 <button class="close btn-sm">Remove Child</button></li>');
    li.data('wishlist-id', id);
    list.find('ul').append(li);
  } else {
    $(".search-entry[data-wishlist-id=" + id + "] a").removeClass('disabled');
    $(".search-entry[data-wishlist-id=" + id + "] a").html('Sponsor This Child');

  }

  return idList;
}

function addIdToCart(id) {
  var wishlist = $('.search-entry[data-wishlist-id=' + id + ']');
  addToCart(wishlist);
}

function addToCart(entry) {
  var idList = updateIdList(entry.data('wishlist-id'), entry.find('h3').html());

  entry.find('a').addClass('disabled');
  entry.find('a').html('Selected')
}

function updateCheckoutUrl(idList) {
  var checkoutBtn = $('#checkout-btn');
  if (idList.length == 0) {
    $('#empty-list-message').show();
    checkoutBtn.addClass('disabled');
  } else {
    $('#empty-list-message').hide();
    checkoutBtn.removeClass('disabled');
  }

  var href = checkoutBtn.attr('href');
  if (href) {
    href = href.replace(/\?.+/, "") + "?id_list=" + idList;
    checkoutBtn.attr('href', href);
  }
}

$('body').on("change", '#addl_donation', function() {
  var link = $("#checkout-btn").attr('href');
  $("#checkout-btn-2").attr("href", link + '&addl_donation=' + $(this).val());
});

$('body').on("change", '#addl_donation_slug', function() {
  var link = $("#program-checkout").attr('href');
  $("#checkout-btn-3").attr("href", link + '&addl_donation=' + $(this).val());
});

</script>
<% end %>
<%= render 'common/modal' %>
